{"version":3,"sources":["../../../src/datastore/lmdb/lmdb-datastore.ts"],"names":["lmdbDatastore","getNode","getTypes","countNodes","iterateNodes","iterateNodesByType","updateDataStore","ready","runQuery","getNodes","getNodesByType","rootDbFile","process","env","NODE_ENV","FORCE_TEST_DATABASE_ID","JEST_WORKER_ID","rootDb","databases","getRootDb","name","path","cwd","compression","getDatabases","nodes","openDB","cache","nodesByType","dupSort","metadata","useVersions","indexes","result","Array","from","type","nodesDb","GatsbyIterable","getKeys","snapshot","map","nodeId","undefined","filter","Boolean","getValues","id","get","asArray","typeName","stats","getStats","Number","entryCount","getValuesCount","args","GATSBY_EXPERIMENTAL_LMDB_INDEXES","datastore","Promise","resolve","lastOperationPromise","action","dbs","transactionSync","clear","clearIndexes","all","setupLmdbStore","state","Map","emitter","on"],"mappings":"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","sourcesContent":["import { RootDatabase, open } from \"lmdb-store\"\n// import { performance } from \"perf_hooks\"\nimport { ActionsUnion, IGatsbyNode } from \"../../redux/types\"\nimport { updateNodes } from \"./updates/nodes\"\nimport { updateNodesByType } from \"./updates/nodes-by-type\"\nimport { IDataStore, ILmdbDatabases, IQueryResult } from \"../types\"\nimport { emitter, replaceReducer } from \"../../redux\"\nimport { GatsbyIterable } from \"../common/iterable\"\nimport { doRunQuery } from \"./query/run-query\"\nimport {\n  IRunFilterArg,\n  runFastFiltersAndSort,\n} from \"../in-memory/run-fast-filters\"\n\nconst lmdbDatastore = {\n  getNode,\n  getTypes,\n  countNodes,\n  iterateNodes,\n  iterateNodesByType,\n  updateDataStore,\n  ready,\n  runQuery,\n\n  // deprecated:\n  getNodes,\n  getNodesByType,\n}\n\nconst rootDbFile =\n  process.env.NODE_ENV === `test`\n    ? `test-datastore-${\n        // FORCE_TEST_DATABASE_ID will be set if this gets executed in worker context\n        // when running jest tests. JEST_WORKER_ID will be set when this gets executed directly\n        // in test context (jest will use jest-worker internally).\n        process.env.FORCE_TEST_DATABASE_ID ?? process.env.JEST_WORKER_ID\n      }`\n    : `datastore`\n\nlet rootDb\nlet databases\n\nfunction getRootDb(): RootDatabase {\n  if (!rootDb) {\n    rootDb = open({\n      name: `root`,\n      path: process.cwd() + `/.cache/data/` + rootDbFile,\n      compression: true,\n    })\n  }\n  return rootDb\n}\n\nfunction getDatabases(): ILmdbDatabases {\n  if (!databases) {\n    const rootDb = getRootDb()\n    databases = {\n      nodes: rootDb.openDB({\n        name: `nodes`,\n        // FIXME: sharedStructuresKey breaks tests - probably need some cleanup for it on DELETE_CACHE\n        // sharedStructuresKey: Symbol.for(`structures`),\n        // @ts-ignore\n        cache: true,\n      }),\n      nodesByType: rootDb.openDB({\n        name: `nodesByType`,\n        dupSort: true,\n      }),\n      metadata: rootDb.openDB({\n        name: `metadata`,\n        useVersions: true,\n      }),\n      indexes: rootDb.openDB({\n        name: `indexes`,\n        // TODO: use dupSort when this is ready: https://github.com/DoctorEvidence/lmdb-store/issues/66\n        // dupSort: true\n      }),\n    }\n  }\n  return databases\n}\n\n/**\n * @deprecated\n */\nfunction getNodes(): Array<IGatsbyNode> {\n  // const start = performance.now()\n  const result = Array.from<IGatsbyNode>(iterateNodes())\n  // const timeTotal = performance.now() - start\n  // console.warn(\n  //   `getNodes() is deprecated, use iterateNodes() instead; ` +\n  //     `array length: ${result.length}; time(ms): ${timeTotal}`\n  // )\n  return result ?? []\n}\n\n/**\n * @deprecated\n */\nfunction getNodesByType(type: string): Array<IGatsbyNode> {\n  // const start = performance.now()\n  const result = Array.from<IGatsbyNode>(iterateNodesByType(type))\n  // const timeTotal = performance.now() - start\n  // console.warn(\n  //   `getNodesByType() is deprecated, use iterateNodesByType() instead; ` +\n  //     `array length: ${result.length}; time(ms): ${timeTotal}`\n  // )\n  return result ?? []\n}\n\nfunction iterateNodes(): GatsbyIterable<IGatsbyNode> {\n  // Additionally fetching items by id to leverage lmdb-store cache\n  const nodesDb = getDatabases().nodes\n  return new GatsbyIterable(\n    nodesDb\n      .getKeys({ snapshot: false })\n      .map(\n        nodeId => (typeof nodeId === `string` ? getNode(nodeId) : undefined)!\n      )\n      .filter(Boolean)\n  )\n}\n\nfunction iterateNodesByType(type: string): GatsbyIterable<IGatsbyNode> {\n  const nodesByType = getDatabases().nodesByType\n  return new GatsbyIterable(\n    nodesByType\n      .getValues(type)\n      .map(nodeId => getNode(nodeId)!)\n      .filter(Boolean)\n  )\n}\n\nfunction getNode(id: string): IGatsbyNode | undefined {\n  if (!id) return undefined\n  const { nodes } = getDatabases()\n  return nodes.get(id)\n}\n\nfunction getTypes(): Array<string> {\n  return getDatabases().nodesByType.getKeys({}).asArray\n}\n\nfunction countNodes(typeName?: string): number {\n  if (!typeName) {\n    const stats = getDatabases().nodes.getStats()\n    // @ts-ignore\n    return Number(stats.entryCount || 0) // FIXME: add -1 when restoring shared structures key\n  }\n\n  const { nodesByType } = getDatabases()\n  return nodesByType.getValuesCount(typeName)\n}\n\nasync function runQuery(args: IRunFilterArg): Promise<IQueryResult> {\n  if (process.env.GATSBY_EXPERIMENTAL_LMDB_INDEXES) {\n    return await doRunQuery({\n      datastore: lmdbDatastore,\n      databases: getDatabases(),\n      ...args,\n    })\n  }\n  return Promise.resolve(runFastFiltersAndSort(args))\n}\n\nlet lastOperationPromise: Promise<any> = Promise.resolve()\n\nfunction updateDataStore(action: ActionsUnion): void {\n  switch (action.type) {\n    case `DELETE_CACHE`: {\n      const dbs = getDatabases()\n      // Force sync commit\n      dbs.nodes.transactionSync(() => {\n        dbs.nodes.clear()\n        dbs.nodesByType.clear()\n        dbs.metadata.clear()\n        dbs.indexes.clear()\n      })\n      break\n    }\n    case `SET_PROGRAM`: {\n      // TODO: remove this when we have support for incremental indexes in lmdb\n      clearIndexes()\n      break\n    }\n    case `CREATE_NODE`:\n    case `ADD_FIELD_TO_NODE`:\n    case `ADD_CHILD_NODE_TO_PARENT_NODE`:\n    case `DELETE_NODE`: {\n      const dbs = getDatabases()\n      lastOperationPromise = Promise.all([\n        updateNodes(dbs.nodes, action),\n        updateNodesByType(dbs.nodesByType, action),\n      ])\n    }\n  }\n}\n\nfunction clearIndexes(): void {\n  const dbs = getDatabases()\n  dbs.nodes.transactionSync(() => {\n    dbs.metadata.clear()\n    dbs.indexes.clear()\n  })\n}\n\n/**\n * Resolves when all the data is synced\n */\nasync function ready(): Promise<void> {\n  await lastOperationPromise\n}\n\nexport function setupLmdbStore(): IDataStore {\n  replaceReducer({\n    nodes: (state = new Map(), action) =>\n      action.type === `DELETE_CACHE` ? new Map() : state,\n    nodesByType: (state = new Map(), action) =>\n      action.type === `DELETE_CACHE` ? new Map() : state,\n  })\n  emitter.on(`*`, action => {\n    if (action) {\n      updateDataStore(action)\n    }\n  })\n  // TODO: remove this when we have support for incremental indexes in lmdb\n  clearIndexes()\n  return lmdbDatastore\n}\n"],"file":"lmdb-datastore.js"}